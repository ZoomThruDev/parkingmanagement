<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" />
<title>Add Vehicle</title>
<link href='https://fonts.googleapis.com/css?family=Roboto:400,100italic,300,100,300italic,400italic,500,500italic,700,700italic,900italic,900' rel='stylesheet' type='text/css'>
<link rel="stylesheet" type="text/css" href="../style.css">
</head>

<script type="text/javascript" src="../js/jquery.js"></script>
<script type="text/javascript" src="../js/validate.js"></script>
<script src="../js/jquery-ui.js"></script>
<script type="text/javascript" src="../js/config.js"></script>
<script type="text/javascript">
jQuery(document).ready(function(){
	
	
	jQuery( document ).on( "mobileinit", function() {
		jQuery.mobile.allowCrossDomainPages = true;
	});
	var contentType ="application/x-www-form-urlencoded; charset=utf-8";
    if(window.XDomainRequest){contentType = "text/plain";}
	jQuery.support.cors = true;
	var uid=gup('uid');
	checkloggedin(uid);
	var url=siteurl+'/api/towvehicle';
    var v=gup('v');
		jQuery.ajax({  
			 type: 'POST',  
			 url: url,  
			 dataType: 'json',  
			 data: {uid:uid, authorisedvehicles:1},  
			 crossDomain: true,  
			 beforeSend: function() {
				jQuery('body .bodyoverlay').remove();
				jQuery('body .preloader').remove();
				var html='<div class="bodyoverlay"></div><div class="preloader"></div>';
				jQuery('body').append(html);					
			 },		
			 complete: function() {
				//jQuery('body .bodyoverlay').remove();
				jQuery('body .preloader').remove();					
			 },
			 success: function(res) {  
				
				jQuery('body .bodyoverlay').remove();
				jQuery(res['vehiclelist']).each(function(k){
					jQuery('#vechileid').append('<option value="'+res['vehiclelist'][k]['id']+'">'+res['vehiclelist'][k]['name']+'</option>');
				});
				jQuery('#vechileid').val(v);
				
				jQuery(res['trucklist']).each(function(k){
					jQuery('#truckid').append('<option value="'+res['trucklist'][k]['id']+'">'+res['trucklist'][k]['name']+'</option>');
				});
				jQuery(res['storagelist']).each(function(k){
					jQuery('#storage_id').append('<option value="'+res['storagelist'][k]['id']+'">'+res['storagelist'][k]['name']+'</option>');
				});
				jQuery(res['towingreasons']).each(function(k){
					jQuery('.towingreasons').append('<label><input type="checkbox" name="towingreasons[]" value="'+res['towingreasons'][k]+'" />'+res['towingreasons'][k]+'</label><div class="clr"></div>');
				});
				
				jQuery('body .popupbox').remove();
			 },  
			 error: function(response, d, a){
				jQuery('body .bodyoverlay').remove();
				jQuery('body .popupbox').remove();
				var html='<div class="bodyoverlay"></div><div class="popupbox errorbox"><div class="popupimg"><img src="../images/error.png" /></div><h1 class="success">ERROR</h1><h1>Server Error.</h1><button class="okbox">OK</button></div>';
				jQuery('body').append(html);
				
				jQuery('.okbox').click(function(){
					jQuery('body .bodyoverlay').remove();
					jQuery('body .popupbox').remove();
				});
				return false; 
			 } 
		   });
	   jQuery('#edituser').validate();
	 jQuery('#edituser').submit(function(){
	 	
		var error=false;
		jQuery('#edituser input, #edituser textarea').each(function(){
			if(jQuery(this).hasClass('error'))
			{
				error=true;
			}
		});
		var formData = jQuery('#edituser').serialize();
		
		formData = formData + '&uid=' + uid+ '&addvehicle=1';
		
		if(!error)
		{
			jQuery.ajax({  
			 type: 'POST',  
			 url: url,  
			 dataType: 'json',  
			 data: formData,  
			 crossDomain: true,  
			 beforeSend: function() {
				jQuery('body .bodyoverlay').remove();
				jQuery('body .preloader').remove();
				var html='<div class="bodyoverlay"></div><div class="preloader"></div>';
				jQuery('body').append(html);					
			 },		
			 complete: function() {
				//jQuery('body .bodyoverlay').remove();
				jQuery('body .preloader').remove();					
			 },
			 success: function(res) {  
				if(res['vehicles']['error'])
				{
					jQuery('body .bodyoverlay').remove();
					jQuery('body .popupbox').remove();
					var html='<div class="bodyoverlay"></div><div class="popupbox errorbox"><div class="popupimg"><img src="../images/error.png" /></div><h1 class="success">ERROR</h1><h1>';
					jQuery(res['vehicles']['error']).each(function(k){
						html+=res['vehicles']['error'][k]+'<br />';
					});
					
					html+='</h1><button class="okbox">OK</button></div>';
					jQuery('body').append(html);
					
				}
				else if(res['vehicles']['updatevehicle'])
				{
					jQuery('body .bodyoverlay').remove();
					jQuery('body .popupbox').remove();
					var html='<div class="bodyoverlay"></div><div class="popupbox"><div class="popupimg"><img src="../images/pop.png" /></div><h1 class="success">SUCCESS</h1><h1>'+res['vehicles']['updatevehicle']+'.</h1><button class="okbox">OK</button></div>';
					jQuery('body').append(html);
					jQuery('#edituser')[0].reset();
					
				}
				jQuery('.okbox').click(function(){
					jQuery('body .bodyoverlay').remove();
					jQuery('body .popupbox').remove();
				}); 
				return false;
			 },  
			 error: function(response, d, a){
				jQuery('body .bodyoverlay').remove();
				jQuery('body .popupbox').remove();
				var html='<div class="bodyoverlay"></div><div class="popupbox errorbox"><div class="popupimg"><img src="../images/error.png" /></div><h1 class="success">ERROR</h1><h1>Server Error.</h1><button class="okbox">OK</button></div>';
				jQuery('body').append(html);
				
				jQuery('.okbox').click(function(){
					jQuery('body .bodyoverlay').remove();
					jQuery('body .popupbox').remove();
				});
				return false; 
			 } 
		   });
	   }
	   return false;
	 });
});		
</script>
<script type="text/javascript" src="../cordova.js"></script>
<script type="text/javascript">
var images = [];
var $imagesDiv;
document.addEventListener("deviceready", init, false);
function init() {
	document.querySelector("#startScan").addEventListener("touchend", startScan, false);
	jQuery("#addPicture").on("touchend", selPic);
    $imagesDiv = jQuery("#images");  
    jQuery("#uploadPictures").on("touchend", uploadPics);
}

function startScan() {

	cordova.plugins.barcodeScanner.scan(
		function (result) {
			var txxt=result.text.split('|');
			var ticket_id=txxt[1];
			checkcheckin(ticket_id);
			
		}, 
		function (error) {
			//alert("Scanning failed: " + error);
			jQuery('body .bodyoverlay').remove();
			jQuery('body .popupbox').remove();
			var html='<div class="bodyoverlay"></div><div class="popupbox errorbox"><div class="popupimg"><img src="images/error.png" /></div><h1 class="success">ERROR</h1><h1>Scanning failed: '+ error+'</h1><button class="okbox">OK</button></div>';
			jQuery('body').append(html);
			
			jQuery('.okbox').click(function(){
				jQuery('body .bodyoverlay').remove();
				jQuery('body .popupbox').remove();
			});
		}
	);

}

function selPic() {
    navigator.camera.getPicture(function(f) {
        var newHtml = "<img src='"+f+"'>";
        $imagesDiv.append(newHtml);
        images.push(f);
        if(images.length === 1) {
            jQuery("#uploadPictures").removeAttr("disabled");
        }
    }, function(e) {
        alert("Error, check console.");
        console.dir(e);
    }, { 
        quality: 50,
        sourceType: Camera.PictureSourceType.PHOTOLIBRARY,
        destinationType: Camera.DestinationType.FILE_URI
    });
    
}
function uploadPics() {
    alert("Ok, going to upload "+images.length+" images.");
    jQuery(images).each(function(i) {
        alert('processing '+images[i]);
        //var def = $.Deferred();

        function win(r) {
            alert("thing done");
            if(jQuery.trim(r.response) === "0") {
                alert("this one failed");
                //def.resolve(0);
            } else {
                alert("this one passed");
                //def.resolve(1);
            }
        }

        function fail(error) {
            alert("upload error source " + error.source);
            alert("upload error target " + error.target);
            //def.resolve(0);
        }

        var uri = encodeURI(siteurl+"/api/save-vehicle-images?uid="+uid+'&i='+i);

        var options = new FileUploadOptions();
        options.fileKey="file";
        options.fileName=images[i].substr(images[i].lastIndexOf('/')+1);
        options.mimeType="image/jpeg";

        var ft = new FileTransfer();
		ft.onprogress = function(progressEvent) {
			if (progressEvent.lengthComputable) {
			  loadingStatus.setPercentage(progressEvent.loaded / progressEvent.total);
			} else {
			  loadingStatus.increment();
			}
		};
        ft.upload(i, uri, win, fail, options);
        //defs.push(def.promise());
        
    });

    

}



</script>
<body>
<div class="wrapper">
	<div class="container">
		<header>
			<div class="menu_div">
				<a href="javascript:;" class="showhidemenus"><img src="../images/menu32@64.png"></a>
				<ul class="menus"></ul>
			</div>
			<script type="text/javascript">document.write(language_en_menus());</script>
				<div class="logo_div">
					<a href="#"><img src="../images/logo.png"></a>
				</div>
		</header><!------------------header close-------------------------------->
		<!--------------------------content-div starts------------------------------------------->	
			<div class="content_div manager_search">
				
				<div class="inner_content"><!--------------------------inner_content------------------------------------------->
					<h4 class="search_headng">ADD VEHICLE</h4>
					   <div class="select_div">
						  <form name="edituser" id="edituser" action="" method="post">
							<div class="field">
								<select class="selectpicker form-control required" name="vechileid" id="vechileid">
								  <option data-tokens="" value="">Select Vehicle or search eg model color tagnumber</option>
								</select>
							</div>
							  <div class="field">
								<select class="selectpicker form-control required" name="truckid" id="truckid" data-live-search="true">
								  <option data-tokens="" value="">Select Truck</option>
							    </select>
							  </div>
							  
							  <div class="field">
								<select class="selectpicker form-control required" name="storage_id" id="storage_id" data-live-search="true">
								  <option data-tokens="" value="">Select Storage</option>
								</select>
								</div>
							  <div class="field">
							  	<label for="treasons">Towing Reasons</label>
								<div class="clr"></div>
								<div class="towingreasons"></div>
							  </div>
							  <div class="field">
								<div class="cmra"><a href="javascript:;" id="startScan"><img src="../images/camera.png"></a></div>
							  </div>
							  <div class="clr"></div>
							  <div class="field">
								<div class="cmra"><a href="javascript:;" id="addPicture">addPicture</a></div>
							  </div>
							  <div class="clr"></div>
							  <div class="field">
								<div class="cmra" id="images"></div>
							  </div>
							  <div class="clr"></div>
							  <div class="field">
								<div class="cmra"><a href="javascript:;" id="uploadPictures">uploadPictures</a></div>
							  </div>
							  <div class="clr"></div>
							<button class="btn btn-success" name="update" type="submit">Add</button>
						  </form>
					   </div>
				</div>.
			</div>
		
	</div>
</div>

</body>
</html>